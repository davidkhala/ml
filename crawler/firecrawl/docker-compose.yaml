name: firecrawl

x-jwt-secret: &jwt-secret "your-super-secret-jwt-token-with-at-least-32-characters-long"

# x-common-env: &common-env
#   REDIS_URL: ${REDIS_URL:-redis://redis:6379}
#   REDIS_RATE_LIMIT_URL: ${REDIS_URL:-redis://redis:6379}
#   PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_MICROSERVICE_URL:-http://playwright-service:3000/scrape}
#   NUQ_DATABASE_URL: postgres://postgres:postgres@nuq-postgres:5432/postgres
#   LOGGING_LEVEL: ${LOGGING_LEVEL:-info}
#   PROXY_SERVER: ${PROXY_SERVER}
#   PROXY_USERNAME: ${PROXY_USERNAME}
#   PROXY_PASSWORD: ${PROXY_PASSWORD}
#   #
#   INTERNAL_PORT: ${INTERNAL_PORT}
#   EXTRACT_WORKER_PORT: ${EXTRACT_WORKER_PORT}
#   BLOCK_MEDIA: ${BLOCK_MEDIA}
#   WORKER_PORT: ${WORKER_PORT}
#   #
#   TEST_API_KEY: my-local-key
#   USE_DB_AUTHENTICATION: true
  
#   SUPABASE_URL: http://supabase-rest:3000
  


services:
  playwright-service:
    image: ghcr.io/firecrawl/playwright-service:latest
    environment:
      PORT: 3000
      PROXY_SERVER: 
      PROXY_USERNAME: 
      PROXY_PASSWORD: 

  api:
    image: ghcr.io/firecrawl/firecrawl
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      HOST: "0.0.0.0"
      PORT: 3002
      EXTRACT_WORKER_PORT: 3004
      WORKER_PORT: 3005
      ENV: local
      NUQ_DATABASE_URL: postgres://postgres:postgres@nuq-postgres:5432/postgres
      USE_DB_AUTHENTICATION: true
      SUPABASE_URL: http://supabase-rest:3000
    depends_on:
      - redis
      - playwright-service
      - supabase-rest
      - nuq-postgres
    ports:
      - "3002:${INTERNAL_PORT:-3002}"
    command: node dist/src/harness.js --start-docker

  redis:
    image: redis:alpine

    command: redis-server --bind 0.0.0.0

  nuq-postgres:
    image: ghcr.io/firecrawl/nuq-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
  supabase-db:
    image: supabase/postgres:15.8.1.085
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      POSTGRES_USER: supabase_admin
    volumes:
      - ./supabase/roles.sql:/docker-entrypoint-initdb.d/init-scripts/99-roles.sql:Z
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  supabase-auth:
    image: supabase/gotrue:v2.183.0
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://localhost:8000
      
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://supabase_auth_admin:postgres@supabase-db:5432/postgres
      
      GOTRUE_SITE_URL: http://localhost:3000
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_SECRET: *jwt-secret
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:9999/health"
        ]
      timeout: 5s
      interval: 5s
      retries: 3
  supabase-rest:
    image: postgrest/postgrest:v13.0.7
    depends_on:
      supabase-auth:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://authenticator:postgres@supabase-db:5432/postgres
      PGRST_DB_SCHEMAS: public,storage,graphql_public
      PGRST_DB_ANON_ROLE: anon
      PGRST_DB_USE_LEGACY_GUCS: "false"
      PGRST_JWT_SECRET: *jwt-secret
      PGRST_APP_SETTINGS_JWT_SECRET: *jwt-secret
      PGRST_APP_SETTINGS_JWT_EXP: 3600